<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>考勤卡</title>
    <link rel="stylesheet" href="/css/time-card.css">
</head>
<body>
    <div class="layui-card title">
        <div class="layui-card-header name" id="title"></div>
        <button class="layui-btn layui-btn-primary" onclick="history.go(-1)">返回</button>
    </div>
    
    <div id="time-card-list"></div>

</body>
<script type="text/html" id="time-card">

  {{# for (const year of d) { }}

    <div class="layui-card">
      <div class="layui-card-header">
        <span>{{ year }}年</span>
        <button class="layui-btn">更新</button>
      </div>
      <div class="layui-card-body">
          <table class="layui-table calendar-table" id="year-{{ year }}">
              <colgroup>
                <col width="100">
                <col width="100">
                <col width="100">
                <col width="100">
                <col width="100">
                <col width="100">
                <col width="100">
                <col width="100">
                <col width="100">
                <col width="100">
                <col width="100">
                <col width="100">
                <col width="100">
                <col width="100">
              </colgroup>
              <thead>
                <tr>
                  <th>考勤</th>
                  <th>1月</th>
                  <th>2月</th>
                  <th>3月</th>
                  <th>4月</th>
                  <th>5月</th>
                  <th>6月</th>
                  <th>7月</th>
                  <th>8月</th>
                  <th>9月</th>
                  <th>10月</th>
                  <th>11月</th>
                  <th>12月</th>
                  <th>合计</th>
                </tr> 
              </thead>
              <tbody>
                <tr>
                  <td>工日</td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="1"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                </tr>
                <tr>
                  <td>工时</td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="8"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                </tr>
                <tr class="wages">
                  <td>工价</td>
                  <td><input type="number" value="100"></td>
                  <td><input type="number" value="100"></td>
                  <td><input type="number" value="100"></td>
                  <td><input type="number" value="100"></td>
                  <td><input type="number" value="100"></td>
                  <td><input type="number" value="100"></td>
                  <td><input type="number" value="100"></td>
                  <td><input type="number" value="100"></td>
                  <td><input type="number" value="100"></td>
                  <td><input type="number" value="100"></td>
                  <td><input type="number" value="100"></td>
                  <td><input type="number" value="100"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly"></td>
                </tr>
                <tr>
                  <td>奖金</td>
                  <td><input type="number" value="0"></td>
                  <td><input type="number" value="0"></td>
                  <td><input type="number" value="0"></td>
                  <td><input type="number" value="0"></td>
                  <td><input type="number" value="0"></td>
                  <td><input type="number" value="0"></td>
                  <td><input type="number" value="0"></td>
                  <td><input type="number" value="0"></td>
                  <td><input type="number" value="0"></td>
                  <td><input type="number" value="0"></td>
                  <td><input type="number" value="0"></td>
                  <td><input type="number" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly"></td>
                </tr>
                <tr>
                  <td>支款</td>
                  <td><input type="number" value="0"></td>
                  <td><input type="number" value="0"></td>
                  <td><input type="number" value="0"></td>
                  <td><input type="number" value="0"></td>
                  <td><input type="number" value="0"></td>
                  <td><input type="number" value="0"></td>
                  <td><input type="number" value="0"></td>
                  <td><input type="number" value="0"></td>
                  <td><input type="number" value="0"></td>
                  <td><input type="number" value="0"></td>
                  <td><input type="number" value="0"></td>
                  <td><input type="number" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly"></td>
                </tr>
                <tr>
                  <td>应发工资</td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
                </tr>
                <tr>
                  <td>实发工资</td>
                  <td><input type="number"></td>
                  <td><input type="number"></td>
                  <td><input type="number"></td>
                  <td><input type="number"></td>
                  <td><input type="number"></td>
                  <td><input type="number"></td>
                  <td><input type="number"></td>
                  <td><input type="number"></td>
                  <td><input type="number"></td>
                  <td><input type="number"></td>
                  <td><input type="number"></td>
                  <td><input type="number"></td>
                  <td><input type="number" class="layui-disabled" readonly="readonly"></td>
                </tr>
              </tbody>
          </table>
      </div>
    </div>

  {{# } }}
    
  
</script>
<script type="text/html" id="calendar-month">
  <table class="layui-table calendar-table-day" id="calendar-table-day">
    <thead>
      <tr>
        <th>日期</th>
        <th>星期</th>
        <th>上午</th>
        <th>下午</th>
        <th>工时</th>
      </tr> 
    </thead>
    <tbody>
      {{# for(const day of d.calendar){ }}
        <tr id="{{ day.date }}">
          <td>{{ day.day }}</td>
          <td>{{ day.dayOfWeek }}</td>
          {{# 
            var fChecked = day.forenoon == 1 ? 'checked' : ''; 
            var aChecked = day.afternoon == 1 ? 'checked' : '';
          }}
          <td><input type="checkbox" checked="{{ fChecked }}"></td>
          <td><input type="checkbox" checked="{{ aChecked }}"></td>
          <td><input type="number" value="{{ day.hour }}"></td>
        </tr>
      {{# } }}

    </tbody>
  </table>
</script>
<!-- <script type="text/html" id="calendar-month">
  <table class="layui-table calendar-table-day">
    <thead>
      <tr>
        <th>星期日</th>
        <th>星期一</th>
        <th>星期二</th>
        <th>星期三</th>
        <th>星期四</th>
        <th>星期五</th>
        <th>星期六</th>
      </tr> 
    </thead>
    <tbody>

      {{# for(var i = 0;i < 36;i ++){ }}
        {{#
          var remainder = i % 7;
          var dayOfWeek;
          if(remainder == 0){
            dayOfWeek = '星期日';
          }else if(remainder == 1){
            dayOfWeek = '星期一';
          }else if(remainder == 2){
            dayOfWeek = '星期二';
          }else if(remainder == 3){
            dayOfWeek = '星期三';
          }else if(remainder == 4){
            dayOfWeek = '星期四';
          }else if(remainder == 5){
            dayOfWeek = '星期五';
          }else if(remainder == 6){
            dayOfWeek = '星期六';
          }
        }}
        {{# if(d.calendar[d.index] != undefined){ }}
          {{# if(i != 0 && remainder == 0){ }}
            </tr>
          {{# } }}
          {{# if(remainder == 0){ }}
            <tr>
          {{# } }}
          {{# if(d.calendar[d.index].dayOfWeek == dayOfWeek){ }}
              <td>
                <div>
                  <span>{{ d.calendar[d.index].dd }}</span>
                  <input type="number" min="0" max="24">
                </div>
              </td>
              {{# d.index ++; }}
          {{# }else{ }}
              <td></td>
          {{# } }}
        {{# } }}
        {{# if(d.index == d.calendar.length){ }}
          </tr>
          {{# d.index ++ }}
        {{# } }}
      {{# } }}

    </tbody>
  </table>
</script> -->
<script src="/js/config.js"></script>
<script src="/js/common.js"></script>
<script src="/js/jquery-3.4.1.min.js"></script>
<script src="/layui/layui.js"></script>
<script>

  layui.use(['layer','laytpl'], function(){
    var layer = layui.layer; 
    var laytpl = layui.laytpl;
    var projectId = getParamFromUrl('projectId');
    var projectName = getParamFromUrl('projectName');
    var employeeId = getParamFromUrl('employeeId');
    var employeeName = getParamFromUrl('employeeName');
    var employeeType = getParamFromUrl('employeeType');
    $('#title').text(employeeName + ' - ' + employeeType + ' - ' + projectName);

    render();
    

    function render(){

      $.ajax({
        url: baseUrl + '/sidan/finance/attendance/year',
        type: 'get',
        data: {
          projectId: projectId,
          employeeId: employeeId
        },
        dataType: 'json',
        async: false,
        success: function(json){
          console.log(json);
          var tpl = $('#time-card').html();
          laytpl(tpl).render(json.list,function(html){
            $('#time-card-list').html(html);
          });
          
        }
      });

    }

    $('.calendar-table thead th').on('click',function(e){
      var year = $(this).parent().parent().parent().attr('id').replace('year-','');
      var month = $(this).index() < 10 ? '0' + $(this).index() : '' + $(this).index();
      if(month > 0 && month <= 12){
        $.ajax({
          url: baseUrl + '/sidan/finance/attendance/calendar',
          type: 'get',
          data: {
            year: year,
            month: month
          },
          dataType: 'json',
          success: function(json){
            console.log(json);
            if(json.code == 0){
              var tpl = $('#calendar-month').html();
              json.index = 0;
              laytpl(tpl).render(json, function(html){
                layer.closeAll();
                layer.open({
                  type: 1,
                  title: '考勤表：' + year + '/' + month,
                  shadeClose: true,
                  shade: false,
                  resize: false,
                  area: '500px',
                  content: html,
                  cancel: function(){
                    var rows = $('.calendar-table-day tbody tr');
                    console.log(rows);
                    var days = [];
                    for (const row of rows) {
                      var date = $(row).attr('id');
                      var forenoon = $(row).find('input')[0];
                      var afternoon = $(row).find('input')[1];
                      var hour = $(row).find('input')[2];
                      var day = {
                        date: date,
                        forenoon: forenoon.checked,
                        afternoon: afternoon.checked,
                        hour: hour.value
                      }
                      days.push(day);
                    }
                    console.log(days);
                    $.ajax({
                      url: baseUrl + '/sidan/finance/attendance/calendar/update',
                      type: 'post',
                      data: {
                        projectId: projectId,
                        employeeId: employeeId,
                        days: JSON.stringify(days)
                      },
                      dateType: 'json',
                      success: function(json){
                        console.log(json);
                      }
                    });

                  }
                  
                });
              });
  
            }else{
              console.log(josn.msg);
            }
          }
        });
      }
      
    });


    $('.calendar-table td input').on('input',function(e){
      var type = $(this).parent().parent().attr('class');
      var year = $(this).parent().parent().parent().parent().attr('id').replace('year-','');
      var month = $(this).parent().index();

      var parent = $(this).parent().parent().parent();
      var day = $(parent).find('tr')[0].children[month].children[0];
      var hour =  $(parent).find('tr')[1].children[month].children[0];
      var wage =  $(parent).find('tr')[2].children[month].children[0];
      var bonus =  $(parent).find('tr')[3].children[month].children[0];
      var withdraw =  $(parent).find('tr')[4].children[month].children[0];
      var salary =  $(parent).find('tr')[5].children[month].children[0];

      var totalSalary =  $(parent).find('tr')[4].children[13].children[0];
      
      if(type != 'wages'){
        //本行求和
        var row_sum = $(this).parent().parent()[0].children;
        var currentSum = $(this).parent().parent()[0].children[13].children[0];
        $(currentSum).val(sum(row_sum));
      }

      console.log(bonus.value);
      //（工时/6+工日）*工价
      var amount = (Number(hour.value) / 6 + Number(day.value)) * Number(wage.value) + Number(bonus.value) - Number(withdraw.value);
      $(salary).val(amount.toFixed(2));
      
      var row_salary = $(parent).find('tr')[4].children;
      $(totalSalary).val(sum(row_salary));
      
    });

    function sum(tdArray){
      var total = 0;
      for(var i = 1;i < tdArray.length - 1;i ++){
        total += Number($(tdArray[i].children[0]).val());
      }
      return total;
    }

  });


</script>
</html>