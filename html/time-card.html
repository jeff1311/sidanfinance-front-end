<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>考勤卡</title>
    <link rel="stylesheet" href="/css/time-card.css">
</head>
<body>
    <div class="layui-card title">
        <div class="layui-card-header name" id="title"></div>
        <button class="layui-btn layui-btn-primary" onclick="history.go(-1)">返回</button>
    </div>
    
    <div id="time-card-list"></div>

</body>
<script type="text/html" id="time-card">

  <div class="layui-tab">
    <ul class="layui-tab-title">
      {{# for (const i in d.list) { }}
        {{# if(i == d.list.length - 1){ }}
          <li class="layui-this" id="tab-{{ d.list[i] }}">{{ d.list[i] }}</li>
        {{# }else{ }}
          <li id="tab-{{ d.list[i] }}">{{ d.list[i] }}</li>
        {{# } }}
      {{# } }}
    </ul>
    <div class="layui-tab-content">
      {{# for (const i in d.list) { }}
        {{# if(i == d.list.length - 1){ }}
          <div class="layui-tab-item layui-show" id="tab-content-{{ d.list[i] }}"></div>
        {{# }else{ }}
          <div class="layui-tab-item" id="tab-content-{{ d.list[i] }}"></div>
        {{# } }}
      {{# } }}
    </div>
  </div>

</script>
<script type="text/html" id="time-card-content">
  {{# 
    var days = 0;
    var hours = 0;
    var bonus = 0;
    var withdraw = 0;
    var amount = 0;
    var actualAmount = 0;
    for(const m of d){
      days += m.day;
      hours += m.hour;
      bonus += m.bonus;
      withdraw += m.withdraw;
      amount += m.amount;
      actualAmount += m.actualAmount;
    }
  }}
  <table class="layui-table calendar-table" id="year-{{ d[0].year }}">
      <colgroup>
        <col width="100">
        <col width="100">
        <col width="100">
        <col width="100">
        <col width="100">
        <col width="100">
        <col width="100">
        <col width="100">
        <col width="100">
        <col width="100">
        <col width="100">
        <col width="100">
        <col width="100">
        <col width="100">
      </colgroup>
      <thead>
        <tr>
          <th>考勤</th>
          <th>1月</th>
          <th>2月</th>
          <th>3月</th>
          <th>4月</th>
          <th>5月</th>
          <th>6月</th>
          <th>7月</th>
          <th>8月</th>
          <th>9月</th>
          <th>10月</th>
          <th>11月</th>
          <th>12月</th>
          <th>合计</th>
        </tr> 
      </thead>
      <tbody>
        <tr>
          <td>工日</td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[0].day }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[1].day }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[2].day }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[3].day }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[4].day }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[5].day }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[6].day }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[7].day }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[8].day }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[9].day }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[10].day }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[11].day }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ days }}"></td>
        </tr>
        <tr>
          <td>工时</td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[0].hour }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[1].hour }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[2].hour }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[3].hour }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[4].hour }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[5].hour }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[6].hour }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[7].hour }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[8].hour }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[9].hour }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[10].hour }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[11].hour }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ hours }}"></td>
        </tr>
        <tr class="price">
          <td>工价</td>
          <td><input type="number" value="{{ d[0].price }}"></td>
          <td><input type="number" value="{{ d[1].price }}"></td>
          <td><input type="number" value="{{ d[2].price }}"></td>
          <td><input type="number" value="{{ d[3].price }}"></td>
          <td><input type="number" value="{{ d[4].price }}"></td>
          <td><input type="number" value="{{ d[5].price }}"></td>
          <td><input type="number" value="{{ d[6].price }}"></td>
          <td><input type="number" value="{{ d[7].price }}"></td>
          <td><input type="number" value="{{ d[8].price }}"></td>
          <td><input type="number" value="{{ d[9].price }}"></td>
          <td><input type="number" value="{{ d[10].price }}"></td>
          <td><input type="number" value="{{ d[11].price }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly"></td>
        </tr>
        <tr>
          <td>奖金</td>
          <td><input type="number" value="{{ d[0].bonus }}"></td>
          <td><input type="number" value="{{ d[1].bonus }}"></td>
          <td><input type="number" value="{{ d[2].bonus }}"></td>
          <td><input type="number" value="{{ d[3].bonus }}"></td>
          <td><input type="number" value="{{ d[4].bonus }}"></td>
          <td><input type="number" value="{{ d[5].bonus }}"></td>
          <td><input type="number" value="{{ d[6].bonus }}"></td>
          <td><input type="number" value="{{ d[7].bonus }}"></td>
          <td><input type="number" value="{{ d[8].bonus }}"></td>
          <td><input type="number" value="{{ d[9].bonus }}"></td>
          <td><input type="number" value="{{ d[10].bonus }}"></td>
          <td><input type="number" value="{{ d[11].bonus }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ bonus }}"></td>
        </tr>
        <tr>
          <td>支款</td>
          <td><input type="number" value="{{ d[0].withdraw }}"></td>
          <td><input type="number" value="{{ d[1].withdraw }}"></td>
          <td><input type="number" value="{{ d[2].withdraw }}"></td>
          <td><input type="number" value="{{ d[3].withdraw }}"></td>
          <td><input type="number" value="{{ d[4].withdraw }}"></td>
          <td><input type="number" value="{{ d[5].withdraw }}"></td>
          <td><input type="number" value="{{ d[6].withdraw }}"></td>
          <td><input type="number" value="{{ d[7].withdraw }}"></td>
          <td><input type="number" value="{{ d[8].withdraw }}"></td>
          <td><input type="number" value="{{ d[9].withdraw }}"></td>
          <td><input type="number" value="{{ d[10].withdraw }}"></td>
          <td><input type="number" value="{{ d[11].withdraw }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ withdraw }}"></td>
        </tr>
        <tr>
          <td>应发工资</td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[0].amount }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[1].amount }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[2].amount }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[3].amount }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[4].amount }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[5].amount }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[6].amount }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[7].amount }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[8].amount }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[9].amount }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[10].amount }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ d[11].amount }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ amount }}"></td>
        </tr>
        <tr>
          <td>实发工资</td>
          <td><input type="number" value="{{ d[0].actualAmount }}"></td>
          <td><input type="number" value="{{ d[1].actualAmount }}"></td>
          <td><input type="number" value="{{ d[2].actualAmount }}"></td>
          <td><input type="number" value="{{ d[3].actualAmount }}"></td>
          <td><input type="number" value="{{ d[4].actualAmount }}"></td>
          <td><input type="number" value="{{ d[5].actualAmount }}"></td>
          <td><input type="number" value="{{ d[6].actualAmount }}"></td>
          <td><input type="number" value="{{ d[7].actualAmount }}"></td>
          <td><input type="number" value="{{ d[8].actualAmount }}"></td>
          <td><input type="number" value="{{ d[9].actualAmount }}"></td>
          <td><input type="number" value="{{ d[10].actualAmount }}"></td>
          <td><input type="number" value="{{ d[11].actualAmount }}"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="{{ actualAmount }}"></td>
        </tr>
      </tbody>
  </table>
</script>
<script type="text/html" id="calendar-month">
  <table class="layui-table calendar-table-day" id="calendar-table-day">
    <thead>
      <tr>
        <th>日期</th>
        <th>星期</th>
        <th>上午</th>
        <th>下午</th>
        <th>工时</th>
      </tr> 
    </thead>
    <tbody>
      {{# for(const day of d.calendar){ }}
        <tr id="{{ day.date }}">
          <td>{{ day.day }}</td>
          <td>{{ day.dayOfWeek }}</td>
          {{# if(day.forenoon){ }}
          <td><input type="checkbox" checked="checked"></td>
          {{# }else{ }}
          <td><input type="checkbox"></td>
          {{# } }}
          {{# if(day.afternoon){ }}
          <td><input type="checkbox" checked="checked"></td>
          {{# }else{ }}
          <td><input type="checkbox"></td>
          {{# } }}
          <td><input type="number" value="{{ day.hour }}"></td>
        </tr>
      {{# } }}

    </tbody>
  </table>
</script>
<script src="/js/config.js"></script>
<script src="/js/common.js"></script>
<script src="/js/jquery-3.4.1.min.js"></script>
<script src="/layui/layui.js"></script>
<script>

  layui.use(['layer','laytpl','element'], function(){
    var layer = layui.layer; 
    var laytpl = layui.laytpl;
    var element = layui.element;
    var projectId = getParamFromUrl('projectId');
    var projectName = getParamFromUrl('projectName');
    var employeeId = getParamFromUrl('employeeId');
    var employeeName = getParamFromUrl('employeeName');
    var employeeType = getParamFromUrl('employeeType');
    $('#title').text(employeeName + ' - ' + employeeType + ' - ' + projectName);

    render();
    
    function render(){

      $.ajax({
        url: baseUrl + '/sidan/finance/attendance/year',
        type: 'get',
        data: {
          projectId: projectId,
          employeeId: employeeId
        },
        dataType: 'json',
        async: false,
        beforeSend: function(){
          layer.load(1, {
            shade: [0.1,'#fff'] //0.1透明度的白色背景
          });
        },
        success: function(json){
          layer.closeAll();
          console.log(json);
          var tpl = $('#time-card').html();
          laytpl(tpl).render(json,function(html){
            $('#time-card-list').html(html);  
          });
          var thisYear = new Date().getFullYear();
          var tpl = $('#time-card-content').html();
          laytpl(tpl).render(json.esList,function(html){
            $('#tab-content-' + thisYear).html(html);
          });
        }
      });

    }

    function renderYear(year){

      $.ajax({
        url: baseUrl + '/sidan/finance/attendance/year/data',
        type: 'get',
        data: {
          projectId: projectId,
          employeeId: employeeId,
          year: year
        },
        dataType: 'json',
        async: false,
        beforeSend: function(){
          layer.load(1, {
            shade: [0.1,'#fff'] //0.1透明度的白色背景
          });
        },
        success: function(json){
          layer.closeAll();
          console.log(json);
          var tpl = $('#time-card-content').html();
          laytpl(tpl).render(json.esList,function(html){
            $('#tab-content-' + year).html(html);
          });
          
        }
      });

      $('.calendar-table thead th').on('click',function(e){
        attendance(this);
      });

      $('.calendar-table td input').on('input',function(e){
        input(this);      
      });

    }

    $('.layui-tab-title li').on('click',function(){
      var year = this.id.replace('tab-','');
      renderYear(year);
    });

    $('.calendar-table thead th').on('click',function(e){
      attendance(this);
    });

    function attendance(_this){
      var year = $(_this).parent().parent().parent().attr('id').replace('year-','');
      var month = $(_this).index() < 10 ? '0' + $(_this).index() : '' + $(_this).index();
      if(month > 0 && month <= 12){
        $.ajax({
          url: baseUrl + '/sidan/finance/attendance/calendar',
          type: 'get',
          data: {
            year: year,
            month: month,
            employeeId: employeeId,
            projectId: projectId
          },
          dataType: 'json',
          beforeSend: function(){
            layer.load(1, {
              shade: [0.1,'#fff'] //0.1透明度的白色背景
            });
          },
          success: function(json){
            layer.closeAll();
            console.log(json);
            if(json.code == 0){
              var tpl = $('#calendar-month').html();
              json.index = 0;
              laytpl(tpl).render(json, function(html){
                layer.closeAll();
                layer.open({
                  type: 1,
                  title: '考勤表：' + year + '/' + month,
                  shadeClose: true,
                  shade: false,
                  resize: false,
                  area: '500px',
                  content: html,
                  cancel: function(){
                    var rows = $('.calendar-table-day tbody tr');
                    var days = [];
                    for (const row of rows) {
                      var date = $(row).attr('id');
                      var forenoon = $(row).find('input')[0];
                      var afternoon = $(row).find('input')[1];
                      var hour = $(row).find('input')[2];
                      var day = {
                        date: date,
                        forenoon: forenoon.checked,
                        afternoon: afternoon.checked,
                        hour: Number(hour.value)
                      }
                      days.push(day);
                    }
                    var diffRows = diff(json.calendar,days);
                    if(diffRows.length > 0){
                      $.ajax({
                        url: baseUrl + '/sidan/finance/attendance/calendar/update',
                        type: 'post',
                        data: {
                          projectId: projectId,
                          employeeId: employeeId,
                          year: year,
                          month: month,
                          days: JSON.stringify(diffRows)
                        },
                        dataType: 'json',
                        beforeSend: function(){
                          layer.load(1, {
                            shade: [0.1,'#fff'] //0.1透明度的白色背景
                          });
                        },
                        success: function(json){
                          console.log(json);
                          layer.closeAll();
                          if(json.code == 0){
                            renderYear(year);
                          }else{
                            console.log(json.msg);
                          }
                        }
                      });
                    }

                  }
                  
                });
              });
  
            }else{
              console.log(josn.msg);
            }
          }
        });
      }
    }

    $('.calendar-table td input').on('input',function(e){
      input(this);      
    });

    function input(_this){
      var type = $(_this).parent().parent().attr('class');
      var year = $(_this).parent().parent().parent().parent().attr('id').replace('year-','');
      var month = $(_this).parent().index();

      var parent = $(_this).parent().parent().parent();
      var day = $(parent).find('tr')[0].children[month].children[0];
      var hour =  $(parent).find('tr')[1].children[month].children[0];
      var price =  $(parent).find('tr')[2].children[month].children[0];
      var bonus =  $(parent).find('tr')[3].children[month].children[0];
      var withdraw =  $(parent).find('tr')[4].children[month].children[0];
      var salary =  $(parent).find('tr')[5].children[month].children[0];
      var totalSalary =  $(parent).find('tr')[5].children[13].children[0];
      var actualAmount = $(parent).find('tr')[6].children[month].children[0];
      
      if(type != 'price'){
        //本行求和
        var row_sum = $(_this).parent().parent()[0].children;
        var currentSum = $(_this).parent().parent()[0].children[13].children[0];
        $(currentSum).val(sum(row_sum));
      }

      //（工时/6+工日）*工价
      var amount = (Number(hour.value) / 6 + Number(day.value)) * Number(price.value) + Number(bonus.value) - Number(withdraw.value);
      var amountTemp = amount.toString().split('.')
      if(amountTemp.length > 1 && amountTemp[1].length > 2){
        amount = amount.toFixed(2);
      }
      $(salary).val(amount);
      
      var row_salary = $(parent).find('tr')[5].children;
      
      $(totalSalary).val(sum(row_salary));

      $.ajax({
        url: baseUrl + '/sidan/finance/attendance/salary/update',
        type: 'post',
        data: {
          projectId: projectId,
          employeeId: employeeId,
          year: year,
          month: month,
          price: price.value,
          bonus: bonus.value,
          withdraw: withdraw.value,
          amount: amount,
          actualAmount: actualAmount.value
        },
        dataType: 'json',
        beforeSend: function(){
          layer.load(1, {
            shade: [0.1,'#fff'] //0.1透明度的白色背景
          });
        },
        success: function(json){
          layer.closeAll();
          console.log(json);
        }
      });

    }

    //求和
    function sum(tdArray){
      var total = 0;
      for(var i = 1;i < tdArray.length - 1;i ++){
        total += Number($(tdArray[i].children[0]).val());
      }
      return total;
    }

    function diff(arr1,arr2){
      var diff = new Array();
      for (var i in arr1) {
        console.log(arr1[i].forenoon != arr2[i].forenoon,arr1[i].afternoon != arr2[i].afternoon,arr1[i].hour != arr2[i].hour);
        if(arr1[i].forenoon != arr2[i].forenoon || arr1[i].afternoon != arr2[i].afternoon || arr1[i].hour != arr2[i].hour){
          diff.push(arr2[i]);
        }
      }
      return diff;
    }

  });


</script>
</html>