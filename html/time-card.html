<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>考勤卡</title>
    <link rel="stylesheet" href="/css/time-card.css">
</head>
<body>
    <div class="layui-card title">
        <div class="layui-card-header name" id="title"></div>
        <button class="layui-btn layui-btn-primary" onclick="history.go(-1)">返回</button>
    </div>
    
    <div id="time-card-list"></div>

</body>
<script type="text/html" id="time-card">

  <div class="layui-tab">
    <ul class="layui-tab-title">
      {{# for (const i in d.list) { }}
        {{# if(i == d.list.length - 1){ }}
          <li class="layui-this" id="tab-{{ d.list[i] }}">{{ d.list[i] }}</li>
        {{# }else{ }}
          <li id="tab-{{ d.list[i] }}">{{ d.list[i] }}</li>
        {{# } }}
      {{# } }}
    </ul>
    <div class="layui-tab-content">
      {{# for (const i in d.list) { }}
        {{# if(i == d.list.length - 1){ }}
          <div class="layui-tab-item layui-show" id="tab-content-{{ d.list[i] }}"></div>
        {{# }else{ }}
          <div class="layui-tab-item" id="tab-content-{{ d.list[i] }}"></div>
        {{# } }}
      {{# } }}
    </div>
  </div>

</script>
<script type="text/html" id="time-card-content">
  <table class="layui-table calendar-table" id="year-{{ d.year }}">
      <colgroup>
        <col width="100">
        <col width="100">
        <col width="100">
        <col width="100">
        <col width="100">
        <col width="100">
        <col width="100">
        <col width="100">
        <col width="100">
        <col width="100">
        <col width="100">
        <col width="100">
        <col width="100">
        <col width="100">
      </colgroup>
      <thead>
        <tr>
          <th>考勤</th>
          <th>1月</th>
          <th>2月</th>
          <th>3月</th>
          <th>4月</th>
          <th>5月</th>
          <th>6月</th>
          <th>7月</th>
          <th>8月</th>
          <th>9月</th>
          <th>10月</th>
          <th>11月</th>
          <th>12月</th>
          <th>合计</th>
        </tr> 
      </thead>
      <tbody>
        <tr>
          <td>工日</td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="1"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
        </tr>
        <tr>
          <td>工时</td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="8"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
        </tr>
        <tr class="wages">
          <td>工价</td>
          <td><input type="number" value="100"></td>
          <td><input type="number" value="100"></td>
          <td><input type="number" value="100"></td>
          <td><input type="number" value="100"></td>
          <td><input type="number" value="100"></td>
          <td><input type="number" value="100"></td>
          <td><input type="number" value="100"></td>
          <td><input type="number" value="100"></td>
          <td><input type="number" value="100"></td>
          <td><input type="number" value="100"></td>
          <td><input type="number" value="100"></td>
          <td><input type="number" value="100"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly"></td>
        </tr>
        <tr>
          <td>奖金</td>
          <td><input type="number" value="0"></td>
          <td><input type="number" value="0"></td>
          <td><input type="number" value="0"></td>
          <td><input type="number" value="0"></td>
          <td><input type="number" value="0"></td>
          <td><input type="number" value="0"></td>
          <td><input type="number" value="0"></td>
          <td><input type="number" value="0"></td>
          <td><input type="number" value="0"></td>
          <td><input type="number" value="0"></td>
          <td><input type="number" value="0"></td>
          <td><input type="number" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly"></td>
        </tr>
        <tr>
          <td>支款</td>
          <td><input type="number" value="0"></td>
          <td><input type="number" value="0"></td>
          <td><input type="number" value="0"></td>
          <td><input type="number" value="0"></td>
          <td><input type="number" value="0"></td>
          <td><input type="number" value="0"></td>
          <td><input type="number" value="0"></td>
          <td><input type="number" value="0"></td>
          <td><input type="number" value="0"></td>
          <td><input type="number" value="0"></td>
          <td><input type="number" value="0"></td>
          <td><input type="number" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly"></td>
        </tr>
        <tr>
          <td>应发工资</td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly" value="0"></td>
        </tr>
        <tr>
          <td>实发工资</td>
          <td><input type="number"></td>
          <td><input type="number"></td>
          <td><input type="number"></td>
          <td><input type="number"></td>
          <td><input type="number"></td>
          <td><input type="number"></td>
          <td><input type="number"></td>
          <td><input type="number"></td>
          <td><input type="number"></td>
          <td><input type="number"></td>
          <td><input type="number"></td>
          <td><input type="number"></td>
          <td><input type="number" class="layui-disabled" readonly="readonly"></td>
        </tr>
      </tbody>
  </table>
</script>
<script type="text/html" id="calendar-month">
  <table class="layui-table calendar-table-day" id="calendar-table-day">
    <thead>
      <tr>
        <th>日期</th>
        <th>星期</th>
        <th>上午</th>
        <th>下午</th>
        <th>工时</th>
      </tr> 
    </thead>
    <tbody>
      {{# for(const day of d.calendar){ }}
        <tr id="{{ day.date }}">
          <td>{{ day.day }}</td>
          <td>{{ day.dayOfWeek }}</td>
          {{# if(day.forenoon){ }}
          <td><input type="checkbox" checked="checked"></td>
          {{# }else{ }}
          <td><input type="checkbox"></td>
          {{# } }}
          {{# if(day.afternoon){ }}
          <td><input type="checkbox" checked="checked"></td>
          {{# }else{ }}
          <td><input type="checkbox"></td>
          {{# } }}
          <td><input type="number" value="{{ day.hour }}"></td>
        </tr>
      {{# } }}

    </tbody>
  </table>
</script>
<script src="/js/config.js"></script>
<script src="/js/common.js"></script>
<script src="/js/jquery-3.4.1.min.js"></script>
<script src="/layui/layui.js"></script>
<script>

  layui.use(['layer','laytpl','element'], function(){
    var layer = layui.layer; 
    var laytpl = layui.laytpl;
    var element = layui.element;
    var projectId = getParamFromUrl('projectId');
    var projectName = getParamFromUrl('projectName');
    var employeeId = getParamFromUrl('employeeId');
    var employeeName = getParamFromUrl('employeeName');
    var employeeType = getParamFromUrl('employeeType');
    $('#title').text(employeeName + ' - ' + employeeType + ' - ' + projectName);

    render();
    
    function render(){

      $.ajax({
        url: baseUrl + '/sidan/finance/attendance/year',
        type: 'get',
        data: {
          projectId: projectId,
          employeeId: employeeId
        },
        dataType: 'json',
        async: false,
        beforeSend: function(){
          layer.load(1, {
            shade: [0.1,'#fff'] //0.1透明度的白色背景
          });
        },
        success: function(json){
          layer.closeAll();
          console.log(json);
          var tpl = $('#time-card').html();
          laytpl(tpl).render(json,function(html){
            $('#time-card-list').html(html);  
          });
          var thisYear = new Date().getFullYear();
          renderYear(thisYear);
        }
      });

    }

    function renderYear(year){

      $.ajax({
        url: baseUrl + '/sidan/finance/attendance/year/data',
        type: 'get',
        data: {
          projectId: projectId,
          employeeId: employeeId,
          year: year
        },
        dataType: 'json',
        async: false,
        beforeSend: function(){
          layer.load(1, {
            shade: [0.1,'#fff'] //0.1透明度的白色背景
          });
        },
        success: function(json){
          layer.closeAll();
          console.log(json);
          json.year = year;
          var tpl = $('#time-card-content').html();
          laytpl(tpl).render(json,function(html){
            $('.layui-show').html(html);
          });
          
        }
      });

    }

    $('.calendar-table thead th').on('click',function(e){
      var year = $(this).parent().parent().parent().attr('id').replace('year-','');
      var month = $(this).index() < 10 ? '0' + $(this).index() : '' + $(this).index();
      if(month > 0 && month <= 12){
        $.ajax({
          url: baseUrl + '/sidan/finance/attendance/calendar',
          type: 'get',
          data: {
            year: year,
            month: month,
            employeeId: employeeId,
            projectId: projectId
          },
          dataType: 'json',
          beforeSend: function(){
            layer.load(1, {
              shade: [0.1,'#fff'] //0.1透明度的白色背景
            });
          },
          success: function(json){
            layer.closeAll();
            console.log(json);
            if(json.code == 0){
              var tpl = $('#calendar-month').html();
              json.index = 0;
              laytpl(tpl).render(json, function(html){
                layer.closeAll();
                layer.open({
                  type: 1,
                  title: '考勤表：' + year + '/' + month,
                  shadeClose: true,
                  shade: false,
                  resize: false,
                  area: '500px',
                  content: html,
                  cancel: function(){
                    var rows = $('.calendar-table-day tbody tr');
                    var days = [];
                    for (const row of rows) {
                      var date = $(row).attr('id');
                      var forenoon = $(row).find('input')[0];
                      var afternoon = $(row).find('input')[1];
                      var hour = $(row).find('input')[2];
                      var day = {
                        date: date,
                        forenoon: forenoon.checked,
                        afternoon: afternoon.checked,
                        hour: Number(hour.value)
                      }
                      days.push(day);
                    }
                    var diffRows = diff(json.calendar,days);
                    if(diffRows.length > 0){
                      $.ajax({
                        url: baseUrl + '/sidan/finance/attendance/calendar/update',
                        type: 'post',
                        data: {
                          projectId: projectId,
                          employeeId: employeeId,
                          days: JSON.stringify(diffRows)
                        },
                        dataType: 'json',
                        beforeSend: function(){
                          layer.load(1, {
                            shade: [0.1,'#fff'] //0.1透明度的白色背景
                          });
                        },
                        success: function(json){
                          layer.closeAll();
                          if(json.code == 0){
                            window.location.reload();
                          }else{
                            console.log(json.msg);
                          }
                        }
                      });
                    }

                  }
                  
                });
              });
  
            }else{
              console.log(josn.msg);
            }
          }
        });
      }
      
    });


    $('.calendar-table td input').on('input',function(e){
      var type = $(this).parent().parent().attr('class');
      var year = $(this).parent().parent().parent().parent().attr('id').replace('year-','');
      var month = $(this).parent().index();

      var parent = $(this).parent().parent().parent();
      var day = $(parent).find('tr')[0].children[month].children[0];
      var hour =  $(parent).find('tr')[1].children[month].children[0];
      var wage =  $(parent).find('tr')[2].children[month].children[0];
      var bonus =  $(parent).find('tr')[3].children[month].children[0];
      var withdraw =  $(parent).find('tr')[4].children[month].children[0];
      var salary =  $(parent).find('tr')[5].children[month].children[0];

      var totalSalary =  $(parent).find('tr')[4].children[13].children[0];
      
      if(type != 'wages'){
        //本行求和
        var row_sum = $(this).parent().parent()[0].children;
        var currentSum = $(this).parent().parent()[0].children[13].children[0];
        $(currentSum).val(sum(row_sum));
      }

      console.log(bonus.value);
      //（工时/6+工日）*工价
      var amount = (Number(hour.value) / 6 + Number(day.value)) * Number(wage.value) + Number(bonus.value) - Number(withdraw.value);
      $(salary).val(amount.toFixed(2));
      
      var row_salary = $(parent).find('tr')[4].children;
      $(totalSalary).val(sum(row_salary));
      
    });

    function sum(tdArray){
      var total = 0;
      for(var i = 1;i < tdArray.length - 1;i ++){
        total += Number($(tdArray[i].children[0]).val());
      }
      return total;
    }

    function diff(arr1,arr2){
      var diff = new Array();
      for (var i in arr1) {
        console.log(arr1[i].forenoon != arr2[i].forenoon,arr1[i].afternoon != arr2[i].afternoon,arr1[i].hour != arr2[i].hour);
        if(arr1[i].forenoon != arr2[i].forenoon || arr1[i].afternoon != arr2[i].afternoon || arr1[i].hour != arr2[i].hour){
          diff.push(arr2[i]);
        }
      }
      return diff;
    }

  });


</script>
</html>